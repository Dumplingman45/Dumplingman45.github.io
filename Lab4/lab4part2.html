<html>
  <head>
    <title>Leaflet.timeline</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>
    <script src="https://skeate.dev/Leaflet.timeline/examples/leaflet.timeline.js"></script>
    <style>
      html, body { margin: 0; padding: 0; }
      #info { position: fixed; top: 0; left: 0; bottom: 0; width: 25vw; padding: 1em; }
      #map { position: fixed; top: 0; left: 25vw; bottom: 0; right: 0; }
      .leaflet-bottom.leaflet-left { width: 100%; }
      .leaflet-control-container .leaflet-timeline-controls {
        box-sizing: border-box; width: 100%; margin: 0; margin-bottom: 15px;
      }
    </style>
  </head>
  <body>
    <div id="info">
      <p>Latest poll from:</p>
      <ul id="displayed-list"></ul>
    </div>
    <div id="map"></div>
    <script>
      function getColorFor(value) {
        return value > 0   ? '#2166ac' :
               value === 0 ? '#ffffbf' :
                             '#b2182b';
      }

      var minValue = 1;
      var minRadius = 4;

      function calcRadius(val) {
        return 1.0083 * Math.pow(Number(val) / minValue, .5716) * minRadius;
      }

      var background = L.tileLayer(
        'https://stamen-tiles-{s}.a.ssl.fastly.net/toner-background/{z}/{x}/{y}{r}.{ext}',
        { attribution: '', subdomains: 'abcd', minZoom: 0, maxZoom: 20, ext: 'png' }
      );

      var map = L.map("map", {
        layers: [background],
        center: new L.LatLng(38, -95),
        zoom: 4
      });

      function updateList(timeline) {
        var displayed = timeline.getLayers();
        var list = document.getElementById("displayed-list");
        list.innerHTML = "";
        displayed.forEach(function (elec) {
          var li = document.createElement("li");
          li.innerHTML = elec.feature.properties.NAME +
            ' - Biden: ' + elec.feature.properties.DEM +
            ', Trump: ' + elec.feature.properties.REP;
          list.appendChild(li);
        });
      }

      function onLoadData(data) {
        var getInterval = function (elec) {
          return { start: elec.properties.start, end: elec.properties.end };
        };

        var timelineControl = L.timelineSliderControl({
          formatOutput: function (date) { return new Date(date).toString(); },
        });

        var timeline = L.timeline(data, {
          getInterval: getInterval,
          pointToLayer: function (feature, latlng) {
            return L.circleMarker(latlng, {
              radius: calcRadius(feature.properties.EV_EV),
              color: getColorFor(feature.properties.DIFF),
              fillColor: getColorFor(feature.properties.DIFF),
              fillOpacity: 0.8
            }).bindPopup('<p>Electoral votes: ' + feature.properties.EV_EV + '</p>');
          },
        });

        timelineControl.addTo(map);
        timelineControl.addTimelines(timeline);
        timeline.addTo(map);
        timeline.on("change", function (e) { updateList(e.target); });
        updateList(timeline);
      }

      // Fetch the file as text, strip the JSONP wrapper "onLoadData(...)" then parse as JSON
      fetch('https://raw.githubusercontent.com/Dumplingman45/Dumplingman45.github.io/main/Drivemytruckdrinkmybeer.json')
        .then(function(response) { return response.text(); })
        .then(function(text) {
          // Strip the JSONP wrapper: remove "onLoadData(" from start and ")" from end
          var stripped = text.trim();
          if (stripped.startsWith('onLoadData(')) {
            stripped = stripped.slice('onLoadData('.length, -1);
          }
          var data = JSON.parse(stripped);
          onLoadData(data);
        })
        .catch(function(err) { console.error('Failed to load data:', err); });
    </script>
  </body>
</html>